name: Generate Briefings

on:
  # Run 3x daily at briefing times (UTC - adjust for your timezone)
  schedule:
    - cron: '30 7 * * *'   # 7:30 AM UTC (Morning)
    - cron: '30 13 * * *'  # 1:30 PM UTC (Afternoon)
    - cron: '30 20 * * *'  # 8:30 PM UTC (Evening)

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate briefings
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: npx tsx scripts/generator.ts

      - name: Commit and push
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/live/briefings.json
          if git diff --staged --quiet; then
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ðŸ“° Update briefings $(date -u +%Y-%m-%d-%H%M)"
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      - name: Send push notification
        if: steps.commit.outputs.committed == 'true'
        env:
          EXPO_PUSH_TOKEN: ${{ secrets.EXPO_PUSH_TOKEN }}
        run: |
          if [ -z "$EXPO_PUSH_TOKEN" ]; then
            echo "No EXPO_PUSH_TOKEN set, skipping notification"
            exit 0
          fi

          # Determine period based on current UTC hour
          HOUR=$(date -u +%H)
          if [ "$HOUR" -lt 12 ]; then
            PERIOD="morning"
            BODY="Your morning AI briefing is ready"
          elif [ "$HOUR" -lt 18 ]; then
            PERIOD="afternoon"
            BODY="Your afternoon AI briefing is ready"
          else
            PERIOD="evening"
            BODY="Your evening AI briefing is ready"
          fi

          curl -s -X POST https://exp.host/--/api/v2/push/send \
            -H "Content-Type: application/json" \
            -d "{
              \"to\": \"$EXPO_PUSH_TOKEN\",
              \"title\": \"New Briefing Ready\",
              \"body\": \"$BODY\",
              \"sound\": \"default\",
              \"data\": { \"screen\": \"today\" }
            }"
          echo "Push notification sent!"
